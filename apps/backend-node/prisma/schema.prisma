generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String
  plan      String   @default("free")
  
  // Branding & Configuration
  logoUrl        String?  @map("logo_url")
  brandColor     String   @default("#2563eb") @map("brand_color")
  brandingConfig Json?    @map("branding_config") // { primary, secondary, font, logo }
  rbacConfig     Json?    @map("rbac_config")     // { "ROLE": { "feature": boolean } }
  secretsConfig  Json?    @map("secrets_config")  // { "STRIPE_KEY": "...", "OPENAI_KEY": "..." }
  notificationConfig Json? @map("notification_config")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  assets    Asset[]
  workOrders WorkOrder[]
  attachments Attachment[]
  users     User[]
  parts     Part[]
  roles     Role[]
  workOrderSessions WorkOrderSession[]
}

model User {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  email        String   @unique
  username     String?  @map("user_name")
  passwordHash String   @map("password_hash")
  role         String   @default("VIEWER") // ADMIN, TECHNICIAN, VIEWER
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime? @map("deleted_at")
  preferences  Json?    @map("preferences") // { assetLayout: { [assetId]: {x,y} } }
  
  // RBAC Relations
  customRoleId String?  @map("custom_role_id")
  customRole   Role?    @relation(fields: [customRoleId], references: [id])
  
  sessions     WorkOrderSession[] // Relation to time logs
  assignedWorkOrders WorkOrder[] @relation("AssignedWorkOrders")

  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  permissions Json     @default("[]") // ["work_order:read", "asset:write", ...]
  isSystem    Boolean  @default(false) @map("is_system") // System roles (ADMIN, MANAGER) cannot be deleted coverage

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  users       User[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Asset {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  parentId      String?  @map("parent_id")
  name          String
  description   String?
  imageUrl      String?  @map("image_url")
  status        String   @default("OPERATIONAL") // Enum: OPERATIONAL, DOWN, MAINTENANCE
  criticality   String?  @map("criticality") // Nullable for Recursive Inheritance
  hierarchyPath String   @default("/") @map("hierarchy_path") // optimization for search
  lotoConfig    Json?    @map("loto_config") // { electrical: url, pneumatic: url, hydraulic: url }
  documents     Json?    @map("documents")   // [{ name: "Manual", url: "..." }]
  specs         Json?    @map("specs")       // { "Height": "10m", "Power": "220V" }
  metadata      Json?    @map("metadata")    // { position: { x: 0, y: 0 } }
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft Delete cursor

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  parent      Asset?   @relation("AssetHierarchy", fields: [parentId], references: [id])
  children    Asset[]  @relation("AssetHierarchy")
  workOrders  WorkOrder[]
  attachments Attachment[]

  // Indexes for Performance
  @@index([tenantId])
  @@index([parentId])
  @@index([deletedAt])
  @@index([hierarchyPath]) // Optimize path searches
}

model WorkOrder {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  assetId     String   @map("asset_id")
  title       String
  description String?
  priority    String   // Enum: CRITICAL, HIGH, MEDIUM, LOW
  status      String   @default("OPEN") // Enum: OPEN, IN_PROGRESS, DONE
  rimeScore   Int      @map("rime_score") // Calculated: Asset Criticality * Priority
  
  completedAt     DateTime? @map("completed_at")
  completionNotes String?   @map("completion_notes")
  
  assignedUserId String?  @map("assigned_user_id")
  assignedUser   User?    @relation("AssignedWorkOrders", fields: [assignedUserId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Soft Delete

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  asset       Asset    @relation(fields: [assetId], references: [id])
  sessions    WorkOrderSession[]
  attachments Attachment[]
  parts       WorkOrderPart[]

  @@index([tenantId])
  @@index([assetId])
  @@index([rimeScore])
  @@index([assignedUserId])
}

// Replaces InventoryItem
model Part {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  name         String
  sku          String?
  description  String?
  cost         Float    @default(0.0)
  currency     String   @default("GBP") // [NEW] ISO 4217 Currency Code
  quantity     Int      @default(0)
  minQuantity  Int      @default(5) @map("min_quantity")
  binLocation  String?  @map("bin_location")
  imageUrl     String?  @map("image_url")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  transactions InventoryTransaction[]
  workOrderParts WorkOrderPart[]

  @@index([tenantId])
}

model WorkOrderPart {
  id           String   @id @default(uuid())
  workOrderId  String   @map("work_order_id")
  partId       String   @map("part_id")
  quantityUsed Int      @map("quantity_used")
  costAtTime   Float    @map("cost_at_time") // Snapshot of cost when used
  currency     String   @default("GBP")      // [NEW] Snapshot of currency at usage time

  usedAt       DateTime @default(now())

  workOrder    WorkOrder @relation(fields: [workOrderId], references: [id])
  part         Part      @relation(fields: [partId], references: [id])

  @@index([workOrderId])
  @@index([partId])
}

model InventoryTransaction {
  id            String   @id @default(uuid())
  partId        String   @map("part_id")
  changeQuantity Int      @map("change_quantity") // +10, -5, etc.
  type          String   // IN, OUT, AUDIT
  reason        String?
  
  performedAt   DateTime @default(now())
  performedBy   String?  @map("performed_by") // User ID if available

  part          Part     @relation(fields: [partId], references: [id])

  @@index([partId])
}

model Attachment {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  assetId     String?  @map("asset_id")
  workOrderId String?  @map("work_order_id")
  
  fileName    String   @map("file_name")
  mimeType    String   @map("mime_type")
  size        Int
  key         String   // S3 Key: tenants/{tid}/assets/{aid}/{uuid}-{name}
  url         String   // Public URL (or base for presigning)
  
  uploadedAt  DateTime @default(now())

  // Relations
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  asset       Asset?     @relation(fields: [assetId], references: [id])
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])

  @@index([tenantId])
  @@index([assetId])
  @@index([workOrderId])
}

// Session table for connect-pg-simple
model Session {
  sid    String   @id @map("sid")
  sess   Json     @map("sess")
  expire DateTime @map("expire")

  @@map("session")
  @@index([expire], name: "IDX_session_expire")
}

model WorkOrderSession {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  workOrderId String    @map("work_order_id")
  userId      String    @map("user_id")
  
  startTime   DateTime  @default(now())
  endTime     DateTime? // Null equals Active
  duration    Int?      // Computed in minutes when closed

  // Relations
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([workOrderId])
  @@index([userId])
}
